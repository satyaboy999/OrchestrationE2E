name: Local Orchestration Flow

on:
  workflow_dispatch:

jobs:
  selenium-job:
    name: Run Local Selenium Tests
    runs-on: self-hosted
    
    steps:
      - name: Execute Maven Tests
        shell: powershell
        run: |
          Write-Host "Starting Selenium Tests..." -ForegroundColor Cyan
          
          cd "C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project"
          
          if (-not (Test-Path "logs")) {
              New-Item -ItemType Directory -Path "logs" | Out-Null
          }
          
          if (Test-Path "logs/execution.log") {
              Remove-Item "logs/execution.log" -Force
          }
          
          Write-Host "Running full test suite..." -ForegroundColor Yellow
          mvn clean test
          
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Maven tests failed!" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "Maven tests completed!" -ForegroundColor Green
          
          Write-Host "Combining test logs..." -ForegroundColor Cyan
          
          $logFiles = @(
              "logs/OrangeHRMLoginTest.log",
              "logs/ParaBankRegistrationTest.log",
              "logs/WorkingTest1.log"
          )
          
          $combinedContent = @()
          $combinedContent += "================================================================================"
          $combinedContent += "UNIFIED TEST EXECUTION LOG - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          $combinedContent += "================================================================================"
          $combinedContent += ""
          
          foreach ($logFile in $logFiles) {
              if (Test-Path $logFile) {
                  $combinedContent += Get-Content $logFile
                  $combinedContent += ""
              }
          }
          
          $combinedContent | Out-File -FilePath "logs/execution.log" -Encoding UTF8
          
          foreach ($logFile in $logFiles) {
              if (Test-Path $logFile) {
                  Remove-Item $logFile -Force
              }
          }
          
          Write-Host "Individual test logs combined into: logs/execution.log" -ForegroundColor Green
          
          Write-Host "Generating Allure Report..." -ForegroundColor Cyan
          mvn allure:report 2>&1 | Out-Null
          
          Write-Host "Allure report generated!" -ForegroundColor Green
          Write-Host "All tasks completed!" -ForegroundColor Green

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: selenium-test-results
          path: |
            C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\logs\execution.log
            C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\target\allure-results\
            C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\target\site\allure-maven-plugin\

  python-job:
    name: Run Local Python RCA Analysis
    needs: selenium-job
    runs-on: self-hosted
    
    steps:
      - name: Execute Python Main
        shell: powershell
        run: |
          Write-Host "Starting Python RCA Analysis..." -ForegroundColor Cyan
          
          cd "C:\Users\Administrator\Desktop\DA_Failure Analysis Code Base v4_before_log_directory\DA_Failure Analysis Code Base"
          
          python main.py
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "Python Script Completed Successfully!" -ForegroundColor Green
          } else {
              Write-Host "Python Script Failed!" -ForegroundColor Red
              exit 1
          }
      
      - name: Upload RCA Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: rca-analysis-results
          path: C:\Users\Administrator\Desktop\DA_Failure Analysis Code Base v4_before_log_directory\DA_Failure Analysis Code Base\outputs\
