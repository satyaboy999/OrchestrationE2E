name: Local Orchestration Flow

on:
  workflow_dispatch:

jobs:
  selenium-job:
    name: Run Local Selenium Tests
    runs-on: self-hosted
    
    steps:
      - name: Execute Maven Tests
        shell: powershell
        run: |
          Write-Host "Starting Selenium Tests..." -ForegroundColor Cyan
          
          cd "C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project"
          
          if (-not (Test-Path "logs")) {
              New-Item -ItemType Directory -Path "logs" | Out-Null
          }
          
          if (Test-Path "logs/execution.log") {
              Remove-Item "logs/execution.log" -Force
          }
          
          Write-Host "Running full test suite..." -ForegroundColor Yellow
          mvn clean test
          
          Write-Host "Maven execution completed (exit code: $LASTEXITCODE)" -ForegroundColor Green
          
          Write-Host "Combining test logs..." -ForegroundColor Cyan
          
          $logFiles = @(
              "logs/OrangeHRMLoginTest.log",
              "logs/ParaBankRegistrationTest.log",
              "logs/WorkingTest1.log"
          )
          
          $combinedContent = @()
          $combinedContent += "================================================================================"
          $combinedContent += "UNIFIED TEST EXECUTION LOG - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          $combinedContent += "================================================================================"
          $combinedContent += ""
          
          foreach ($logFile in $logFiles) {
              if (Test-Path $logFile) {
                  $combinedContent += Get-Content $logFile
                  $combinedContent += ""
              }
          }
          
          $combinedContent | Out-File -FilePath "logs/execution.log" -Encoding UTF8
          
          foreach ($logFile in $logFiles) {
              if (Test-Path $logFile) {
                  Remove-Item $logFile -Force
              }
          }
          
          Write-Host "Individual test logs combined into: logs/execution.log" -ForegroundColor Green
          
          Write-Host "Generating Allure Report..." -ForegroundColor Cyan
          mvn allure:report 2>&1 | Out-Null
          
          Write-Host "Allure report generated!" -ForegroundColor Green
          Write-Host "All artifacts created successfully!" -ForegroundColor Green
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-results
          path: |
            C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\logs\execution.log
            C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\target\allure-results\
            C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\target\site\allure-maven-plugin\
  
  python-job:
    name: Run Local Python RCA Analysis
    needs: selenium-job
    runs-on: self-hosted
    
    steps:
      - name: Validate Paths Exist
        shell: powershell
        run: |
          $rcaPath = "C:\Users\Administrator\Desktop\Test1\DA_Failure Analysis Code Base"
          $seleniumLogsPath = "C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\logs"
          
          Write-Host "Validating paths..." -ForegroundColor Cyan
          
          if (-not (Test-Path $rcaPath)) {
              Write-Host "ERROR: RCA path not found: $rcaPath" -ForegroundColor Red
              exit 1
          }
          Write-Host "✓ RCA path exists: $rcaPath" -ForegroundColor Green
          
          if (-not (Test-Path $seleniumLogsPath)) {
              Write-Host "ERROR: Selenium logs path not found: $seleniumLogsPath" -ForegroundColor Red
              exit 1
          }
          Write-Host "✓ Selenium logs path exists: $seleniumLogsPath" -ForegroundColor Green
          
          $logFile = "$seleniumLogsPath\execution.log"
          if (-not (Test-Path $logFile)) {
              Write-Host "ERROR: execution.log not found: $logFile" -ForegroundColor Red
              exit 1
          }
          Write-Host "✓ execution.log found" -ForegroundColor Green
      - name: Execute Python RCA Analysis
        shell: powershell
        run: |
          Write-Host "Starting Python RCA Analysis..." -ForegroundColor Cyan
          
          $rcaPath = "C:\Users\Administrator\Desktop\Test1\DA_Failure Analysis Code Base"
          $seleniumLogsPath = "C:\Users\Administrator\Desktop\OrangeHRM_Selenium_Project\logs"
          
          cd $rcaPath
          
          Write-Host "Working directory: $(Get-Location)" -ForegroundColor Yellow
          Write-Host "Input logs from: $seleniumLogsPath" -ForegroundColor Yellow
          Write-Host ""
          
          # Run Python with explicit log directory
          python main.py -p "$seleniumLogsPath"
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host ""
              Write-Host "✓ Python RCA Analysis Completed Successfully!" -ForegroundColor Green
          } else {
              Write-Host ""
              Write-Host "✗ Python RCA Analysis Failed with exit code: $LASTEXITCODE" -ForegroundColor Red
              exit 1
          }
      
      - name: Upload RCA Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rca-analysis-results
          path: |
            C:\Users\Administrator\Desktop\Test1\DA_Failure Analysis Code Base\outputs\
            C:\Users\Administrator\Desktop\Test1\DA_Failure Analysis Code Base\logs_correlated\
            C:\Users\Administrator\Desktop\Test1\DA_Failure Analysis Code Base\logs_unified\
            C:\Users\Administrator\Desktop\Test1\DA_Failure Analysis Code Base\modules\reporting\reports_data\latest.html
